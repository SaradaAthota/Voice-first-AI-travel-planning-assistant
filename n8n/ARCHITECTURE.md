# n8n Architecture - Separation of Concerns

## Overview

This document clarifies the architecture and separation of concerns between the Railway backend and n8n Cloud.

## ⚠️ Critical Understanding

**n8n Cloud does NOT replace your backend logic.**

n8n Cloud is a **workflow orchestration service** that provides:
- Webhook endpoints
- Workflow execution engine
- Email delivery infrastructure
- HTML formatting capabilities

**Your Railway backend still owns ALL business logic.**

## Complete Architecture

```
┌─────────────────────────────────────────────────────────────┐
│  Frontend (Vercel)                                          │
│  - React UI                                                 │
│  - Voice recording                                          │
│  - SSE transcript updates                                   │
└─────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────┐
│  Backend API (Railway) - OWNS ALL BUSINESS LOGIC           │
│                                                              │
│  ✅ Database Operations                                     │
│     - Queries Supabase                                       │
│     - Fetches trips, itineraries, transcripts               │
│                                                              │
│  ✅ Citations Generation                                    │
│     - Generates OSM citations                               │
│     - Generates Wikivoyage citations                         │
│     - Formats citations array                               │
│                                                              │
│  ✅ PDF Generation                                          │
│     - Runs Puppeteer                                        │
│     - Converts HTML → PDF                                    │
│     - Returns PDF binary                                    │
│                                                              │
│  ✅ Business Rules                                          │
│     - Orchestration logic                                   │
│     - Intent routing                                        │
│     - Tool orchestration                                    │
│                                                              │
│  POST /api/itinerary/send-pdf                               │
│    1. Fetches itinerary from Supabase                        │
│    2. Generates citations                                    │
│    3. Calls n8n webhook                                     │
└─────────────────────────────────────────────────────────────┘
                    ↓
        POST https://your-workspace.n8n.cloud/webhook/itinerary-pdf
        {
          "itinerary": { ... },  // From Supabase (backend fetched)
          "email": "user@example.com",
          "citations": [ ... ]   // Generated by backend
        }
                    ↓
┌─────────────────────────────────────────────────────────────┐
│  n8n Cloud - WORKFLOW ORCHESTRATION ONLY                    │
│                                                              │
│  ✅ Webhook Node                                             │
│     - Receives payload from backend                         │
│     - Validates data                                         │
│                                                              │
│  ✅ Format HTML Node                                         │
│     - Converts JSON → Styled HTML                           │
│     - Applies CSS styling                                    │
│     - Formats day-wise breakdown                            │
│                                                              │
│  ✅ Generate PDF Node                                        │
│     - Calls BACKEND: POST {{ BACKEND_URL }}/api/pdf/generate-pdf
│     - Sends HTML to backend                                 │
│     - Receives PDF binary from backend                       │
│     - Does NOT generate PDF itself                           │
│                                                              │
│  ✅ Send Email Node                                          │
│     - Attaches PDF                                           │
│     - Sends via SMTP                                         │
│     - Handles email delivery                                 │
│                                                              │
│  ✅ Respond to Webhook Node                                  │
│     - Returns success response                              │
│     - Backend receives confirmation                          │
└─────────────────────────────────────────────────────────────┘
                    ↓
        POST {{ BACKEND_URL }}/api/pdf/generate-pdf
        { "html": "<html>...</html>" }
                    ↓
        Returns: PDF binary (application/pdf)
                    ↓
        Email sent with PDF attachment
```

## What Backend Owns

### 1. Database Operations
```typescript
// backend/src/routes/itinerary.ts
const { data: itineraryData } = await supabase
  .from('itineraries')
  .select('content')
  .eq('trip_id', tripId)
  .eq('is_active', true)
  .order('version', { ascending: false })
  .limit(1)
  .single();
```

### 2. Citations Generation
```typescript
// backend/src/routes/itinerary.ts
const citations: any[] = [
  {
    source: 'OpenStreetMap',
    url: 'https://www.openstreetmap.org',
    excerpt: `Itinerary built from OpenStreetMap POI data for ${itinerary.city}`,
  },
  {
    source: 'Wikivoyage',
    url: `https://en.wikivoyage.org/wiki/${encodeURIComponent(itinerary.city)}`,
    excerpt: `Travel guide information for ${itinerary.city}`,
  },
];
```

### 3. PDF Generation
```typescript
// backend/src/routes/pdf.ts
router.post('/generate-pdf', async (req: Request, res: Response) => {
  const { html } = req.body;
  
  const browser = await puppeteer.launch({ ... });
  const page = await browser.newPage();
  await page.setContent(html, { waitUntil: 'networkidle0' });
  const pdf = await page.pdf({ format: 'A4', ... });
  
  res.contentType('application/pdf');
  res.send(pdf);
});
```

### 4. Business Rules
- Orchestration logic
- Intent routing
- Tool orchestration
- State management
- All core functionality

## What n8n Cloud Owns

### 1. Workflow Orchestration
- Webhook endpoint hosting
- Workflow execution engine
- Node execution order
- Error handling and retries

### 2. HTML Formatting
- JSON → HTML conversion
- CSS styling
- Template rendering
- Data transformation

### 3. Email Delivery
- SMTP connection management
- Email sending
- Attachment handling
- Delivery status

### 4. Workflow Reliability
- Automatic retries
- Error notifications
- Execution logging
- Monitoring

## Data Flow

### Step 1: Backend Receives Request
```typescript
// POST /api/itinerary/send-pdf
// { tripId, email }
```

### Step 2: Backend Fetches Data
```typescript
// 1. Query Supabase
const itinerary = await fetchFromSupabase(tripId);

// 2. Generate citations
const citations = generateCitations(itinerary);
```

### Step 3: Backend Calls n8n
```typescript
await fetch(process.env.N8N_WEBHOOK_URL, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    itinerary,  // Backend fetched
    email,      // From request
    citations,  // Backend generated
  }),
});
```

### Step 4: n8n Orchestrates
```
Webhook → Format HTML → Generate PDF (calls backend) → Send Email → Respond
```

### Step 5: n8n Calls Backend for PDF
```
POST {{ BACKEND_URL }}/api/pdf/generate-pdf
{ "html": "<html>...</html>" }
→ Returns PDF binary
```

### Step 6: n8n Sends Email
```
Attach PDF → Send via SMTP → User receives email
```

## Why This Architecture?

### Benefits

1. **Separation of Concerns**
   - Backend: Business logic, data, PDF generation
   - n8n: Workflow orchestration, email delivery

2. **Scalability**
   - Backend can scale independently
   - n8n handles workflow reliability

3. **Maintainability**
   - Clear ownership of responsibilities
   - Easy to debug and test

4. **Flexibility**
   - Can swap n8n for other workflow tools
   - Backend logic remains unchanged

### For Evaluators

**Key Points:**
- ✅ Backend owns ALL business logic
- ✅ n8n Cloud only orchestrates workflow
- ✅ PDF generation happens in Railway backend
- ✅ Only webhook URL changes for n8n Cloud
- ✅ Backend code remains identical regardless of n8n deployment

## Environment Variables

### Backend (Railway)
```env
N8N_WEBHOOK_URL=https://your-workspace.n8n.cloud/webhook/itinerary-pdf
```

### n8n Cloud
```env
BACKEND_URL=https://your-backend.up.railway.app
```

**Note**: These are the ONLY environment variables needed. All other logic remains unchanged.

## Testing

### Test Backend Endpoint
```bash
curl -X POST https://your-backend.up.railway.app/api/itinerary/send-pdf \
  -H "Content-Type: application/json" \
  -d '{
    "tripId": "your-trip-id",
    "email": "test@example.com"
  }'
```

### Test n8n Webhook
```bash
curl -X POST https://your-workspace.n8n.cloud/webhook/itinerary-pdf \
  -H "Content-Type: application/json" \
  -d '{
    "itinerary": { ... },
    "email": "test@example.com",
    "citations": [ ... ]
  }'
```

### Test PDF Generation
```bash
curl -X POST https://your-backend.up.railway.app/api/pdf/generate-pdf \
  -H "Content-Type: application/json" \
  -d '{"html": "<html><body>Test</body></html>"}'
```

## Summary

**Backend (Railway):**
- ✅ Owns all business logic
- ✅ Fetches from Supabase
- ✅ Generates citations
- ✅ Generates PDF (Puppeteer)
- ✅ Calls n8n webhook

**n8n Cloud:**
- ✅ Orchestrates workflow
- ✅ Formats HTML
- ✅ Calls backend for PDF
- ✅ Sends email
- ✅ Does NOT replace backend logic

**Only Change for n8n Cloud:**
- Webhook URL in backend: `N8N_WEBHOOK_URL`
- Backend URL in n8n: `BACKEND_URL`
- All other code remains **identical**

---

**Status**: ✅ Architecture Clarified

**Last Updated**: 2024-01-20

